##### Open Prison Education - Docker Environment #####
# NOTE - This file gets rebuilt, make changes to docker-compose-include.yml file
# 		  in individual container directories and run rebuild_compose.py 
#
# Start docker containers by running this command from the main folder:
#		docker-compose up -d
#
# Stop containers by running this command from the main folder:
#		docker-compose down
#
# START OF docker-compose.yml
version: '2'

services:

    ope-dns:
        build: ./ope-dns
        image: ope-dns
        cap_add:
            - NET_ADMIN
        command: -A /ed.dev/127.0.0.1 # --log-facility=-
        ports:
            - "53:53/tcp"
            - "53:53/udp"
        environment:
            - IP_ADDR=127.0.0.1
    ope-gateway:
        build: ./ope-gateway
        image: ope-gateway
        command: --docker.watch --web --docker --docker.domain=ed.dev --logLevel=DEBUG --entryPoints="Name:https Address::443 TLS:/certs/cert.pem,/certs/key.pem" --entryPoints="Name:http Address::80"
        #--entryPoints="Name:https Address::443 TLS:/certs/cert.pem,/certs/key.pem" --entryPoints="Name:http Address::80 Redirect.EntryPoint:https"
        ports:
            - "80:80"
            - "8080:8080"
            - "443:443"
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - /dev/null:/traefik.toml
            # /certs directory can be mapped if you put your certs in the volumes folder
            #- ./volumes/gateway/certs:/certs

    ope-gcf:
        build: ./ope-gcf
        image: ope-gcf
        ports:
            - "80"
        labels:
            - "traefik.backend=gcf"
            - "traefik.frontend.rule=Host:gcf.ed.dev, gcflearnfree.org, gcflearnfree.ed.dev"
            - "traefik.port=80"
            - "traefik.frontend.entryPoints=http"
        volumes:
            - ./volumes/gcf/www:/usr/share/nginx/html:ro
        depends_on:
            - ope-gateway
            - ope-dns
        #environment:
        #    - NGINX_HOST=gcf.ed.dev
        #    - NGINX_PORT=80
        #command: /bin/bash -c "envsubst < /etc/nginx/conf.d/mysite.template > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"
    ope-kalite:
        build: ./ope-kalite
        image: ope-kalite
        ports:
            - "8008"
        labels:
            - "traefik.backend=kalite"
            - "traefik.frontend.rule=Host:kalite.ed.dev, khan.ed.dev"
            - "traefik.port=8008"
            - "traefik.frontend.entryPoints=http"
        volumes:
            - ./volumes/kalite:/root/.kalite:rw
        depends_on:
            - ope-gateway
            - ope-dns
       
    ope-redis:
        build: ./ope-redis
        image: ope-redis
        ports:
            - "6379"
        volumes:
            - ./volumes/redis/data:/data:rw
        depends_on:
            - ope-gateway
            - ope-dns

    ope-smc:
        build: ./ope-smc
        image: ope-smc
        ports:
            - "80"
            - "443"
            #- "8000"
        labels:
            - "traefik.backend=smc"
            - "traefik.frontend.rule=Host:smc.ed.dev, admin.ed.dev, videos.ed.dev, media.ed.dev"
            - "traefik.port=80"
            #- "traefik.port=443"
            #- "traefik.port=8000"
            - "traefik.frontend.entryPoints=http,https"
        volumes:
            - ./volumes/smc/cache:/home/www-data/web2py/applications/smc/cache:rw
            - ./volumes/smc/databases:/home/www-data/web2py/applications/smc/databases:rw
            - ./volumes/smc/errors:/home/www-data/web2py/applications/smc/errors:rw
            - ./volumes/smc/private:/home/www-data/web2py/applications/smc/private:rw
            - ./volumes/smc/media:/home/www-data/web2py/applications/smc/static/media:rw
        depends_on:
            - ope-gateway
            - ope-dns
        #environment:
        #    - NGINX_HOST=gcf.ed.dev
        #    - NGINX_PORT=80
        #command: /bin/bash -c "envsubst < /etc/nginx/conf.d/mysite.template > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"
      